<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kirvano - Sistema Avan√ßado de Monitoramento</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .header h1 {
            font-size: 28px;
            color: #1f2937;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .system-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .system-status.healthy {
            background: #d1fae5;
            color: #065f46;
        }

        .system-status.degraded {
            background: #fef3c7;
            color: #92400e;
        }

        .system-status.critical {
            background: #fecaca;
            color: #991b1b;
        }

        .header p {
            color: #6b7280;
            margin-bottom: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: #f8fafc;
            padding: 16px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
            text-align: center;
            position: relative;
        }

        .stat-card.healthy {
            border-left-color: #10b981;
        }

        .stat-card.warning {
            border-left-color: #f59e0b;
        }

        .stat-card.error {
            border-left-color: #dc2626;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            color: #1f2937;
        }

        .stat-label {
            font-size: 12px;
            color: #6b7280;
            margin-top: 4px;
        }

        .stat-change {
            position: absolute;
            top: 8px;
            right: 8px;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 8px;
            font-weight: 500;
        }

        .stat-change.positive {
            background: #d1fae5;
            color: #065f46;
        }

        .stat-change.negative {
            background: #fecaca;
            color: #991b1b;
        }

        .main-content {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .main-tabs {
            display: flex;
            background: #f8fafc;
            border-bottom: 1px solid #e5e7eb;
        }

        .main-tab {
            flex: 1;
            padding: 16px 24px;
            background: none;
            border: none;
            cursor: pointer;
            font-weight: 600;
            color: #6b7280;
            transition: all 0.2s;
            position: relative;
        }

        .main-tab.active {
            background: white;
            color: #667eea;
            border-bottom: 2px solid #667eea;
        }

        .main-tab .tab-badge {
            position: absolute;
            top: 8px;
            right: 8px;
            background: #dc2626;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 16px;
            text-align: center;
        }

        .tab-content {
            display: none;
            min-height: 600px;
        }

        .tab-content.active {
            display: block;
        }

        /* ‚úÖ NOVO: DASHBOARD DE MONITORAMENTO */
        .monitoring-dashboard {
            padding: 24px;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .instances-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
        }

        .instances-panel h3 {
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .health-controls {
            display: flex;
            gap: 8px;
        }

        .btn-health {
            padding: 6px 12px;
            font-size: 12px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-health.start {
            background: #10b981;
            color: white;
        }

        .btn-health.stop {
            background: #dc2626;
            color: white;
        }

        .instances-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 12px;
        }

        .instance-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px;
            text-align: center;
            transition: all 0.2s;
        }

        .instance-card.online {
            border-color: #10b981;
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
        }

        .instance-card.offline {
            border-color: #dc2626;
            background: linear-gradient(135deg, #fecaca, #fca5a5);
        }

        .instance-card.testing {
            border-color: #f59e0b;
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            animation: pulse 1.5s infinite;
        }

        .instance-card.unknown {
            border-color: #6b7280;
            background: linear-gradient(135deg, #f3f4f6, #e5e7eb);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.02); }
        }

        .instance-name {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .instance-status {
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 8px;
        }

        .instance-stats {
            font-size: 11px;
            color: #6b7280;
        }

        .instance-stats div {
            margin-bottom: 2px;
        }

        .alerts-panel {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .alerts-panel h3 {
            color: #1f2937;
            margin-bottom: 16px;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .alert-item {
            background: white;
            border-left: 4px solid #6b7280;
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .alert-item.info {
            border-left-color: #3b82f6;
        }

        .alert-item.warning {
            border-left-color: #f59e0b;
        }

        .alert-item.error {
            border-left-color: #dc2626;
        }

        .alert-item.critical {
            border-left-color: #dc2626;
            background: #fef2f2;
        }

        .alert-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .alert-message {
            color: #6b7280;
            margin-bottom: 6px;
        }

        .alert-timestamp {
            font-size: 11px;
            color: #9ca3af;
        }

        .alert-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .btn-alert {
            padding: 4px 8px;
            font-size: 11px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: 500;
        }

        .btn-alert.acknowledge {
            background: #3b82f6;
            color: white;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .metrics-card {
            background: #f8fafc;
            border-radius: 12px;
            padding: 20px;
        }

        .metrics-card h4 {
            color: #1f2937;
            margin-bottom: 16px;
            font-size: 16px;
        }

        .metric-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .metric-row:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #6b7280;
            font-size: 14px;
        }

        .metric-value {
            font-weight: 600;
            color: #1f2937;
        }

        .progress-bar {
            width: 60px;
            height: 4px;
            background: #e5e7eb;
            border-radius: 2px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #10b981;
            transition: width 0.3s ease;
        }

        .progress-fill.warning {
            background: #f59e0b;
        }

        .progress-fill.error {
            background: #dc2626;
        }

        /* EDITOR DE FUNIS */
        .funnel-editor {
            display: flex;
            height: 600px;
        }

        .funnel-sidebar {
            width: 300px;
            background: #f8fafc;
            border-right: 1px solid #e5e7eb;
            padding: 24px;
            overflow-y: auto;
        }

        .funnel-selector {
            margin-bottom: 24px;
        }

        .funnel-selector label {
            display: block;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 8px;
        }

        .funnel-selector select {
            width: 100%;
            padding: 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            background: white;
        }

        .funnel-actions {
            margin-bottom: 24px;
            padding: 16px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
        }

        .funnel-actions h3 {
            font-size: 14px;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 8px;
        }

        .btn-small-grid {
            padding: 8px 12px;
            font-size: 12px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s;
        }

        .btn-small-grid:hover {
            background: #5a6fd8;
            transform: translateY(-1px);
        }

        .btn-import {
            background: #10b981;
        }

        .btn-import:hover {
            background: #059669;
        }

        .file-input {
            width: 100%;
            padding: 8px;
            font-size: 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            margin-top: 8px;
        }

        .block-palette {
            margin-bottom: 24px;
        }

        .block-palette h3 {
            font-size: 16px;
            color: #1f2937;
            margin-bottom: 12px;
        }

        .block-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .block-item:hover {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .block-icon {
            width: 32px;
            height: 32px;
            background: #667eea;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .funnel-workspace {
            flex: 1;
            padding: 24px;
            overflow-y: auto;
        }

        .workspace-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .current-funnel {
            font-size: 18px;
            font-weight: 600;
            color: #1f2937;
        }

        .btn {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: all 0.2s;
        }

        .btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-secondary {
            background: #6b7280;
        }

        .btn-danger {
            background: #dc2626;
        }

        .steps-container {
            min-height: 400px;
        }

        .step-card {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 16px;
            transition: all 0.2s;
            position: relative;
        }

        .step-card:hover {
            border-color: #667eea;
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.1);
        }

        .step-card.editing {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .step-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .step-number {
            width: 32px;
            height: 32px;
            background: #667eea;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .step-type {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: #1f2937;
        }

        .step-actions {
            display: flex;
            gap: 8px;
        }

        .step-content {
            margin-left: 40px;
        }

        .step-preview {
            background: #f8fafc;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 12px;
        }

        .step-config {
            display: none;
        }

        .step-config.active {
            display: block;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 6px;
        }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-textarea {
            min-height: 80px;
            resize: vertical;
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 12px 0;
        }

        .connector {
            display: flex;
            justify-content: center;
            margin: -8px 0;
        }

        .connector-line {
            width: 2px;
            height: 30px;
            background: #667eea;
            position: relative;
        }

        .connector-arrow {
            position: absolute;
            bottom: -4px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 4px solid transparent;
            border-right: 4px solid transparent;
            border-top: 8px solid #667eea;
        }

        .empty-workspace {
            text-align: center;
            padding: 60px 20px;
            color: #6b7280;
        }

        .empty-workspace h3 {
            color: #374151;
            margin-bottom: 8px;
        }

        /* LISTA DE EVENTOS */
        .events-container {
            padding: 24px;
        }

        .events-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .events-table th,
        .events-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #f3f4f6;
        }

        .events-table th {
            background: #f8fafc;
            font-weight: 600;
            color: #374151;
            font-size: 14px;
        }

        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success { background: #d1fae5; color: #065f46; }
        .badge-warning { background: #fef3c7; color: #92400e; }
        .badge-info { background: #dbeafe; color: #1e40af; }
        .badge-danger { background: #fecaca; color: #991b1b; }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            border-radius: 8px;
            padding: 16px 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.15);
            z-index: 1000;
            min-width: 300px;
            opacity: 0;
            transform: translateX(100px);
            transition: all 0.3s ease;
        }

        .notification.show {
            opacity: 1;
            transform: translateX(0);
        }

        .notification.success {
            border-left: 4px solid #10b981;
        }

        .notification.error {
            border-left: 4px solid #dc2626;
        }

        .notification.info {
            border-left: 4px solid #3b82f6;
        }

        .notification-title {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 4px;
        }

        .notification-message {
            color: #6b7280;
            font-size: 14px;
        }

        .loading-spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            border: 2px solid #e5e7eb;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 768px) {
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
            
            try {
                showNotification('Salvando...', 'Atualizando funil no servidor', 'info');

                const response = await fetch('/api/funnels', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(currentFunnelData)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Salvo!', 'Funil atualizado com sucesso', 'success');
                    editingStepIndex = -1;
                    renderSteps();
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('‚ùå Erro', 'Erro ao salvar funil: ' + error.message, 'error');
            }
        }

        // LISTA DE EVENTOS
        async function loadEvents() {
            try {
                const response = await fetch('/api/conversations');
                const result = await response.json();
                
                if (result.success) {
                    renderEvents(result.data);
                    
                    // Atualizar badge de conversas
                    const waitingCount = result.data.filter(conv => conv.waiting_for_response).length;
                    const eventsBadge = document.getElementById('eventsBadge');
                    
                    if (waitingCount > 0) {
                        eventsBadge.textContent = waitingCount;
                        eventsBadge.style.display = 'block';
                    } else {
                        eventsBadge.style.display = 'none';
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar eventos:', error);
                document.getElementById('eventsTableBody').innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #dc2626;">
                            Erro ao carregar eventos
                        </td>
                    </tr>
                `;
            }
        }

        function renderEvents(events) {
            const tbody = document.getElementById('eventsTableBody');
            
            if (events.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="9" style="text-align: center; padding: 40px; color: #6b7280;">
                            Nenhuma conversa ativa no momento
                        </td>
                    </tr>
                `;
                return;
            }

            let html = '';
            events.forEach(event => {
                const statusBadge = event.waiting_for_response ? 
                    '<span class="badge badge-warning">Aguardando</span>' : 
                    '<span class="badge badge-success">Pronto</span>';
                
                const productBadge = `<span class="badge badge-info">${event.productType}</span>`;
                const createdAt = new Date(event.createdAt).toLocaleString('pt-BR');

                // ‚úÖ NOVO: Status da inst√¢ncia na conversa
                let instanceHealthBadge = '<span class="badge">-</span>';
                if (event.instanceHealth) {
                    if (event.instanceHealth === 'ONLINE') {
                        instanceHealthBadge = '<span class="badge badge-success">Online</span>';
                    } else if (event.instanceHealth === 'OFFLINE') {
                        instanceHealthBadge = '<span class="badge badge-danger">Offline</span>';
                    } else if (event.instanceHealth === 'TESTING') {
                        instanceHealthBadge = '<span class="badge badge-warning">Testando</span>';
                    } else {
                        instanceHealthBadge = '<span class="badge">Desconhecido</span>';
                    }
                }

                html += `
                    <tr ${event.instanceHealth === 'OFFLINE' ? 'style="background-color: #fef2f2;"' : ''}>
                        <td>${event.customerName}</td>
                        <td>${event.phone}</td>
                        <td>${productBadge}</td>
                        <td>${event.funnelId}</td>
                        <td>${event.stepIndex + 1}</td>
                        <td>${statusBadge}</td>
                        <td>${event.stickyInstance || '-'}</td>
                        <td>${instanceHealthBadge}</td>
                        <td>${createdAt}</td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
        }

        // DASHBOARD
        async function loadDashboard() {
            try {
                const response = await fetch('/api/dashboard');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.data;
                    document.getElementById('statsConversations').textContent = stats.active_conversations || 0;
                    document.getElementById('statsPix').textContent = stats.pending_pix || 0;
                    
                    // Detectar mudan√ßas nas conversas
                    if (previousStats.conversations !== stats.active_conversations) {
                        previousStats.conversations = stats.active_conversations;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // CARREGAR FUNIS DO SERVIDOR
        async function loadFunnelsFromServer() {
            try {
                const response = await fetch('/api/funnels');
                const result = await response.json();
                
                if (result.success) {
                    result.data.forEach(funnel => {
                        if (funnelsData[funnel.id]) {
                            funnelsData[funnel.id] = funnel;
                        }
                    });
                    
                    if (currentFunnelData) {
                        loadFunnelEditor();
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar funis:', error);
            }
        }

        // ‚úÖ MONITORAMENTO: Auto-refresh do dashboard
        function startMonitoring() {
            // Health check das inst√¢ncias a cada 15 segundos
            healthCheckInterval = setInterval(() => {
                if (document.getElementById('monitoring').classList.contains('active')) {
                    loadInstanceHealth();
                }
            }, 15000);
            
            // Alertas a cada 10 segundos
            alertsInterval = setInterval(() => {
                if (document.getElementById('monitoring').classList.contains('active')) {
                    loadAlerts();
                }
            }, 10000);
            
            // Dashboard geral a cada 30 segundos
            setInterval(() => {
                loadDashboard();
                if (document.getElementById('events').classList.contains('active')) {
                    loadEvents();
                }
            }, 30000);
        }

        function stopMonitoring() {
            if (healthCheckInterval) {
                clearInterval(healthCheckInterval);
            }
            if (alertsInterval) {
                clearInterval(alertsInterval);
            }
        }

        // INICIALIZA√á√ÉO
        document.addEventListener('DOMContentLoaded', function() {
            // Carregar dados iniciais
            loadDashboard();
            loadFunnelsFromServer();
            loadFunnelEditor();
            loadInstanceHealth();
            loadAlerts();
            
            // Iniciar monitoramento autom√°tico
            startMonitoring();
            
            // Parar monitoramento quando p√°gina √© fechada
            window.addEventListener('beforeunload', stopMonitoring);
            
            // Adicionar indicador de carregamento no dashboard
            showNotification('üöÄ Sistema Iniciado', 'Monitoramento em tempo real ativo', 'success');
        });

        // ‚úÖ NOVO: Detectar problemas e mostrar notifica√ß√µes autom√°ticas
        let lastNotificationTime = 0;
        
        function checkSystemHealth() {
            // Evitar spam de notifica√ß√µes
            const now = Date.now();
            if (now - lastNotificationTime < 60000) return; // M√°ximo 1 notifica√ß√£o por minuto
            
            // Esta fun√ß√£o ser√° chamada automaticamente para detectar problemas
            const systemStatusEl = document.getElementById('systemStatus');
            const currentStatus = systemStatusEl.className;
            
            if (currentStatus.includes('critical')) {
                showNotification('üö® Sistema Cr√≠tico', 'Muitas inst√¢ncias offline! Verifique o monitoramento.', 'error');
                lastNotificationTime = now;
            } else if (currentStatus.includes('degraded')) {
                showNotification('‚ö†Ô∏è Sistema Degradado', 'Algumas inst√¢ncias est√£o offline.', 'warning');
                lastNotificationTime = now;
            }
        }

        // Verificar sa√∫de do sistema a cada 30 segundos
        setInterval(checkSystemHealth, 30000);
    </script>
</body>
</html>.instances-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .funnel-editor {
                flex-direction: column;
                height: auto;
            }
            
            .funnel-sidebar {
                width: 100%;
            }
            
            .stats-grid {
                grid-template-columns: 1fr 1fr;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .metrics-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>
                üöÄ Kirvano - Sistema Avan√ßado de Monitoramento
                <span class="system-status healthy" id="systemStatus">Sistema Saud√°vel</span>
            </h1>
            <p>Monitoramento em tempo real com health check autom√°tico e migra√ß√£o inteligente</p>
            
            <div class="stats-grid">
                <div class="stat-card healthy">
                    <div class="stat-value" id="statsConversations">-</div>
                    <div class="stat-label">Conversas Ativas</div>
                </div>
                <div class="stat-card" id="healthyInstancesCard">
                    <div class="stat-value" id="statsHealthyInstances">-</div>
                    <div class="stat-label">Inst√¢ncias Online</div>
                    <div class="stat-change positive" id="instancesChange">+0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsPix">-</div>
                    <div class="stat-label">PIX Pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statsFunnels">4</div>
                    <div class="stat-label">Funis Ativos</div>
                </div>
                <div class="stat-card" id="alertsCard">
                    <div class="stat-value" id="statsAlerts">-</div>
                    <div class="stat-label">Alertas Ativos</div>
                    <div class="stat-change negative" id="alertsChange">+0</div>
                </div>
            </div>
        </div>

        <div class="main-content">
            <div class="main-tabs">
                <button class="main-tab active" onclick="switchMainTab('monitoring')">
                    üè• Monitoramento
                    <span class="tab-badge" id="monitoringBadge" style="display: none;">0</span>
                </button>
                <button class="main-tab" onclick="switchMainTab('editor')">üìä Editor de Funis</button>
                <button class="main-tab" onclick="switchMainTab('events')">
                    üìã Conversas
                    <span class="tab-badge" id="eventsBadge" style="display: none;">0</span>
                </button>
            </div>

            <!-- ‚úÖ NOVO: DASHBOARD DE MONITORAMENTO -->
            <div id="monitoring" class="tab-content active">
                <div class="monitoring-dashboard">
                    <div class="dashboard-grid">
                        <!-- PAINEL DE INST√ÇNCIAS -->
                        <div class="instances-panel">
                            <h3>
                                üñ•Ô∏è Status das Inst√¢ncias
                                <div class="health-controls">
                                    <button class="btn-health start" onclick="toggleHealthCheck('start')" id="startHealthBtn">
                                        ‚ñ∂Ô∏è Iniciar
                                    </button>
                                    <button class="btn-health stop" onclick="toggleHealthCheck('stop')" id="stopHealthBtn">
                                        ‚è∏Ô∏è Parar
                                    </button>
                                </div>
                            </h3>
                            <div class="instances-grid" id="instancesGrid">
                                <!-- Inst√¢ncias ser√£o carregadas aqui -->
                            </div>
                        </div>

                        <!-- PAINEL DE ALERTAS -->
                        <div class="alerts-panel">
                            <h3>
                                üö® Alertas do Sistema
                                <small style="font-weight: normal; font-size: 12px;" id="alertsCounter">0 alertas</small>
                            </h3>
                            <div id="alertsList">
                                <div style="text-align: center; color: #6b7280; padding: 20px;">
                                    <div class="loading-spinner"></div>
                                    <div style="margin-top: 8px;">Carregando alertas...</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- M√âTRICAS DETALHADAS -->
                    <div class="metrics-grid">
                        <div class="metrics-card">
                            <h4>üìà Performance do Sistema</h4>
                            <div class="metric-row">
                                <span class="metric-label">Uptime do Sistema</span>
                                <span class="metric-value" id="systemUptime">99.9%</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Health Check Ativo</span>
                                <span class="metric-value" id="healthCheckStatus">Ativo</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">√öltimo Check</span>
                                <span class="metric-value" id="lastHealthCheck">-</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Tempo M√©dio Resposta</span>
                                <span class="metric-value" id="avgResponseTime">150ms</span>
                            </div>
                        </div>

                        <div class="metrics-card">
                            <h4>üîÑ Distribui√ß√£o de Conversas</h4>
                            <div id="conversationDistribution">
                                <!-- Ser√° preenchido dinamicamente -->
                            </div>
                        </div>

                        <div class="metrics-card">
                            <h4>‚ö° Atividade Recente</h4>
                            <div class="metric-row">
                                <span class="metric-label">Mensagens esta Hora</span>
                                <span class="metric-value" id="messagesThisHour">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Migra√ß√µes Hoje</span>
                                <span class="metric-value" id="migrationsToday">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Falhas Detectadas</span>
                                <span class="metric-value" id="failuresToday">0</span>
                            </div>
                            <div class="metric-row">
                                <span class="metric-label">Taxa de Sucesso</span>
                                <span class="metric-value" id="successRate">98%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- EDITOR DE FUNIS -->
            <div id="editor" class="tab-content">
                <div class="funnel-editor">
                    <div class="funnel-sidebar">
                        <div class="funnel-selector">
                            <label>Selecione o Funil:</label>
                            <select id="funnelSelect" onchange="loadFunnelEditor()">
                                <option value="CS_APROVADA">CS - Compra Aprovada</option>
                                <option value="CS_PIX">CS - PIX Pendente</option>
                                <option value="FAB_APROVADA">FAB - Compra Aprovada</option>
                                <option value="FAB_PIX">FAB - PIX Pendente</option>
                            </select>
                        </div>

                        <div class="funnel-actions">
                            <h3>üîÑ Backup e Restaura√ß√£o</h3>
                            <div class="action-buttons">
                                <button class="btn-small-grid" onclick="exportFunnels()">
                                    üì§ Exportar
                                </button>
                                <button class="btn-small-grid btn-import" onclick="document.getElementById('importFile').click()">
                                    üì• Importar
                                </button>
                            </div>
                            <input type="file" id="importFile" class="file-input" accept=".json" onchange="importFunnels()" style="display: none;">
                            <div style="font-size: 11px; color: #6b7280; margin-top: 8px; text-align: center;">
                                Salve seus funis antes do deploy
                            </div>
                        </div>

                        <div class="block-palette">
                            <h3>Adicionar Blocos:</h3>
                            <div class="block-item" onclick="addBlock('text')">
                                <div class="block-icon">T</div>
                                <div>
                                    <div style="font-weight: 600;">Mensagem de Texto</div>
                                    <div style="font-size: 12px; color: #6b7280;">Enviar texto simples</div>
                                </div>
                            </div>
                            
                            <div class="block-item" onclick="addBlock('image')">
                                <div class="block-icon">üì∑</div>
                                <div>
                                    <div style="font-weight: 600;">Imagem</div>
                                    <div style="font-size: 12px; color: #6b7280;">Enviar imagem</div>
                                </div>
                            </div>
                            
                            <div class="block-item" onclick="addBlock('video')">
                                <div class="block-icon">üé•</div>
                                <div>
                                    <div style="font-weight: 600;">V√≠deo</div>
                                    <div style="font-size: 12px; color: #6b7280;">Enviar v√≠deo</div>
                                </div>
                            </div>

                            <div class="block-item" onclick="addBlock('audio')" style="border: 2px solid #f59e0b; background: #fef3c7;">
                                <div class="block-icon" style="background: #f59e0b;">üéµ</div>
                                <div>
                                    <div style="font-weight: 600;">√Åudio</div>
                                    <div style="font-size: 12px; color: #92400e;">Enviar arquivo de √°udio</div>
                                </div>
                            </div>
                            
                            <div class="block-item" onclick="addBlock('image+text')">
                                <div class="block-icon">üìù</div>
                                <div>
                                    <div style="font-weight: 600;">Imagem + Texto</div>
                                    <div style="font-size: 12px; color: #6b7280;">Imagem com legenda</div>
                                </div>
                            </div>
                            
                            <div class="block-item" onclick="addBlock('video+text')">
                                <div class="block-icon">üé¨</div>
                                <div>
                                    <div style="font-weight: 600;">V√≠deo + Texto</div>
                                    <div style="font-size: 12px; color: #6b7280;">V√≠deo com legenda</div>
                                </div>
                            </div>
                            
                            <div class="block-item" onclick="addBlock('delay')">
                                <div class="block-icon">‚è∞</div>
                                <div>
                                    <div style="font-weight: 600;">Delay</div>
                                    <div style="font-size: 12px; color: #6b7280;">Pausar entre mensagens</div>
                                </div>
                            </div>
                            
                            <div class="block-item" onclick="addBlock('typing')">
                                <div class="block-icon">üí¨</div>
                                <div>
                                    <div style="font-weight: 600;">Digitando</div>
                                    <div style="font-size: 12px; color: #6b7280;">Simular "est√° digitando"</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="funnel-workspace">
                        <div class="workspace-header">
                            <div class="current-funnel" id="currentFunnelName">CS - Compra Aprovada</div>
                            <button class="btn" onclick="saveFunnel()">Salvar Funil</button>
                        </div>
                        
                        <div class="steps-container" id="stepsContainer">
                            <div class="empty-workspace">
                                <h3>Funil vazio</h3>
                                <p>Adicione blocos da barra lateral para come√ßar a construir seu funil</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LISTA DE EVENTOS -->
            <div id="events" class="tab-content">
                <div class="events-container">
                    <h2 style="margin-bottom: 20px;">üí¨ Conversas e Envios</h2>
                    <table class="events-table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Telefone</th>
                                <th>Produto</th>
                                <th>Funil</th>
                                <th>Passo Atual</th>
                                <th>Status</th>
                                <th>Inst√¢ncia</th>
                                <th>Sa√∫de Inst√¢ncia</th>
                                <th>Data</th>
                            </tr>
                        </thead>
                        <tbody id="eventsTableBody">
                            <tr>
                                <td colspan="9" style="text-align: center; padding: 40px; color: #6b7280;">
                                    Carregando eventos...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentFunnelData = null;
        let editingStepIndex = -1;
        let healthCheckInterval = null;
        let alertsInterval = null;

        // Dados dos funis
        let funnelsData = {
            'CS_APROVADA': {
                id: 'CS_APROVADA',
                name: 'CS - Compra Aprovada',
                steps: []
            },
            'CS_PIX': {
                id: 'CS_PIX',
                name: 'CS - PIX Pendente',
                steps: []
            },
            'FAB_APROVADA': {
                id: 'FAB_APROVADA',
                name: 'FAB - Compra Aprovada',
                steps: []
            },
            'FAB_PIX': {
                id: 'FAB_PIX',
                name: 'FAB - PIX Pendente',
                steps: []
            }
        };

        // Vari√°veis do sistema
        let previousStats = {
            healthyInstances: 0,
            alerts: 0,
            conversations: 0
        };

        // ‚úÖ SISTEMA DE NOTIFICA√á√ïES
        function showNotification(title, message, type = 'info') {
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());

            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.innerHTML = `
                <div class="notification-title">${title}</div>
                <div class="notification-message">${message}</div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // ‚úÖ MONITORAMENTO: Carregar status das inst√¢ncias
        async function loadInstanceHealth() {
            try {
                const response = await fetch('/api/health');
                const result = await response.json();
                
                if (result.success) {
                    renderInstancesHealth(result);
                    updateSystemStatus(result);
                }
            } catch (error) {
                console.error('Erro ao carregar health das inst√¢ncias:', error);
            }
        }

        // ‚úÖ MONITORAMENTO: Renderizar status das inst√¢ncias
        function renderInstancesHealth(healthData) {
            const grid = document.getElementById('instancesGrid');
            const instances = healthData.instances;
            
            let html = '';
            
            Object.keys(instances).forEach(instanceName => {
                const instance = instances[instanceName];
                const statusClass = instance.status.toLowerCase();
                
                let statusIcon = '‚ùì';
                if (instance.status === 'ONLINE') statusIcon = '‚úÖ';
                else if (instance.status === 'OFFLINE') statusIcon = '‚ùå';
                else if (instance.status === 'TESTING') statusIcon = 'üîÑ';
                
                html += `
                    <div class="instance-card ${statusClass}">
                        <div class="instance-name">${instanceName}</div>
                        <div class="instance-status">${statusIcon} ${instance.status}</div>
                        <div class="instance-stats">
                            <div>üí¨ ${instance.stats.conversationsCount} conversas</div>
                            <div>üìä ${instance.stats.messagesThisHour} msgs/h</div>
                            <div>‚ö° ${instance.responseTime}ms</div>
                            <div>‚úÖ ${instance.stats.successRate}</div>
                        </div>
                    </div>
                `;
            });
            
            grid.innerHTML = html;
        }

        // ‚úÖ MONITORAMENTO: Atualizar status geral do sistema
        function updateSystemStatus(healthData) {
            const system = healthData.system;
            const onlineInstances = system.onlineInstances;
            const totalInstances = system.totalInstances;
            const offlineInstances = system.offlineInstances;
            
            // Status geral do sistema
            const statusEl = document.getElementById('systemStatus');
            if (offlineInstances === 0) {
                statusEl.textContent = 'Sistema Saud√°vel';
                statusEl.className = 'system-status healthy';
            } else if (offlineInstances <= totalInstances / 2) {
                statusEl.textContent = 'Sistema Degradado';
                statusEl.className = 'system-status degraded';
            } else {
                statusEl.textContent = 'Sistema Cr√≠tico';
                statusEl.className = 'system-status critical';
            }
            
            // Atualizar cards de estat√≠sticas
            document.getElementById('statsHealthyInstances').textContent = onlineInstances + '/' + totalInstances;
            
            // Cards coloridos baseados no status
            const healthyCard = document.getElementById('healthyInstancesCard');
            if (offlineInstances === 0) {
                healthyCard.className = 'stat-card healthy';
            } else if (offlineInstances > 0) {
                healthyCard.className = 'stat-card warning';
            }
            
            // Health check status
            document.getElementById('healthCheckStatus').textContent = system.healthCheckActive ? 'Ativo' : 'Inativo';
            
            // √öltimo health check
            if (system.lastHealthCheck > 0) {
                const lastCheck = new Date(system.lastHealthCheck);
                document.getElementById('lastHealthCheck').textContent = lastCheck.toLocaleTimeString('pt-BR');
            }
            
            // Controles de health check
            const startBtn = document.getElementById('startHealthBtn');
            const stopBtn = document.getElementById('stopHealthBtn');
            
            if (system.healthCheckActive) {
                startBtn.style.display = 'none';
                stopBtn.style.display = 'inline-block';
            } else {
                startBtn.style.display = 'inline-block';
                stopBtn.style.display = 'none';
            }

            // Distribui√ß√£o de conversas
            renderConversationDistribution(healthData.instances);
            
            // Detectar mudan√ßas
            const currentHealthy = onlineInstances;
            if (previousStats.healthyInstances !== currentHealthy) {
                const change = currentHealthy - previousStats.healthyInstances;
                const changeEl = document.getElementById('instancesChange');
                
                if (change > 0) {
                    changeEl.textContent = `+${change}`;
                    changeEl.className = 'stat-change positive';
                } else if (change < 0) {
                    changeEl.textContent = `${change}`;
                    changeEl.className = 'stat-change negative';
                } else {
                    changeEl.textContent = '+0';
                }
                
                previousStats.healthyInstances = currentHealthy;
            }
        }

        // ‚úÖ MONITORAMENTO: Renderizar distribui√ß√£o de conversas
        function renderConversationDistribution(instances) {
            const container = document.getElementById('conversationDistribution');
            let html = '';
            
            Object.keys(instances).forEach(instanceName => {
                const instance = instances[instanceName];
                const conversationCount = instance.stats.conversationsCount;
                const maxConversations = Math.max(...Object.values(instances).map(i => i.stats.conversationsCount), 1);
                const percentage = (conversationCount / maxConversations) * 100;
                
                let progressClass = '';
                if (instance.status === 'OFFLINE') progressClass = 'error';
                else if (instance.status === 'TESTING') progressClass = 'warning';
                
                html += `
                    <div class="metric-row">
                        <span class="metric-label">${instanceName}</span>
                        <span class="metric-value">${conversationCount}</span>
                        <div class="progress-bar">
                            <div class="progress-fill ${progressClass}" style="width: ${percentage}%"></div>
                        </div>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<div style="color: #6b7280; text-align: center; padding: 20px;">Nenhuma conversa ativa</div>';
            }
            
            container.innerHTML = html;
        }

        // ‚úÖ MONITORAMENTO: Carregar alertas
        async function loadAlerts() {
            try {
                const response = await fetch('/api/alerts?limit=10');
                const result = await response.json();
                
                if (result.success) {
                    renderAlerts(result.data, result.unacknowledged);
                    
                    // Atualizar badge de alertas
                    const unacknowledged = result.unacknowledged;
                    document.getElementById('statsAlerts').textContent = unacknowledged;
                    
                    const alertsCard = document.getElementById('alertsCard');
                    if (unacknowledged > 0) {
                        alertsCard.className = 'stat-card error';
                    } else {
                        alertsCard.className = 'stat-card';
                    }
                    
                    const monitoringBadge = document.getElementById('monitoringBadge');
                    if (unacknowledged > 0) {
                        monitoringBadge.textContent = unacknowledged;
                        monitoringBadge.style.display = 'block';
                    } else {
                        monitoringBadge.style.display = 'none';
                    }
                    
                    document.getElementById('alertsCounter').textContent = `${result.total} alertas (${unacknowledged} n√£o reconhecidos)`;
                }
            } catch (error) {
                console.error('Erro ao carregar alertas:', error);
            }
        }

        // ‚úÖ MONITORAMENTO: Renderizar alertas
        function renderAlerts(alerts, unacknowledgedCount) {
            const container = document.getElementById('alertsList');
            
            if (alerts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; color: #6b7280; padding: 20px;">
                        <div style="font-size: 48px; margin-bottom: 8px;">‚úÖ</div>
                        <div>Nenhum alerta ativo</div>
                    </div>
                `;
                return;
            }
            
            let html = '';
            alerts.forEach(alert => {
                const timestamp = new Date(alert.timestamp).toLocaleString('pt-BR');
                const isAcknowledged = alert.acknowledged;
                
                html += `
                    <div class="alert-item ${alert.severity} ${isAcknowledged ? 'acknowledged' : ''}" style="${isAcknowledged ? 'opacity: 0.6;' : ''}">
                        <div class="alert-title">${alert.title}</div>
                        <div class="alert-message">${alert.message}</div>
                        <div class="alert-timestamp">${timestamp}</div>
                        ${!isAcknowledged ? `
                        <div class="alert-actions">
                            <button class="btn-alert acknowledge" onclick="acknowledgeAlert('${alert.id}')">
                                ‚úì Reconhecer
                            </button>
                        </div>
                        ` : '<div style="color: #10b981; font-size: 11px; margin-top: 4px;">‚úì Reconhecido</div>'}
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }

        // ‚úÖ MONITORAMENTO: Reconhecer alerta
        async function acknowledgeAlert(alertId) {
            try {
                const response = await fetch(`/api/alerts/${alertId}/acknowledge`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Reconhecido', 'Alerta foi reconhecido', 'success');
                    loadAlerts(); // Recarregar alertas
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('‚ùå Erro', 'Erro ao reconhecer alerta: ' + error.message, 'error');
            }
        }

        // ‚úÖ MONITORAMENTO: Controlar health check
        async function toggleHealthCheck(action) {
            try {
                const response = await fetch('/api/health/toggle', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ action })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showNotification('‚úÖ Health Check', result.message, 'success');
                    loadInstanceHealth(); // Recarregar status
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                showNotification('‚ùå Erro', 'Erro no health check: ' + error.message, 'error');
            }
        }

        // NAVEGA√á√ÉO PRINCIPAL
        function switchMainTab(tabName) {
            document.querySelectorAll('.main-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'events') {
                loadEvents();
            } else if (tabName === 'monitoring') {
                loadInstanceHealth();
                loadAlerts();
            }
        }

        // ‚úÖ EXPORT/IMPORT - Fun√ß√µes de funis
        async function exportFunnels() {
            try {
                showNotification('Exportando...', 'Preparando arquivo de backup dos funis', 'info');

                const response = await fetch('/api/funnels/export');
                
                if (!response.ok) {
                    throw new Error('Erro ao exportar funis');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `kirvano-funnels-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                window.URL.revokeObjectURL(url);

                showNotification('‚úÖ Exportado!', 'Funis salvos com sucesso. Guarde o arquivo em local seguro.', 'success');

            } catch (error) {
                console.error('Erro ao exportar funis:', error);
                showNotification('‚ùå Erro', 'Falha ao exportar funis: ' + error.message, 'error');
            }
        }

        async function importFunnels() {
            const fileInput = document.getElementById('importFile');
            const file = fileInput.files[0];
            
            if (!file) {
                showNotification('‚ö†Ô∏è Aten√ß√£o', 'Selecione um arquivo para importar', 'error');
                return;
            }

            try {
                showNotification('Importando...', 'Processando arquivo de backup', 'info');

                const text = await file.text();
                const importData = JSON.parse(text);

                const response = await fetch('/api/funnels/import', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(importData)
                });

                const result = await response.json();

                if (result.success) {
                    let message = `${result.imported} funis importados`;
                    if (result.skipped > 0) {
                        message += `, ${result.skipped} ignorados (j√° existiam)`;
                    }
                    if (result.errors.length > 0) {
                        message += `, ${result.errors.length} erros`;
                    }

                    showNotification('‚úÖ Importado!', message, 'success');

                    await loadFunnelsFromServer();
                    loadFunnelEditor();

                } else {
                    throw new Error(result.error);
                }

            } catch (error) {
                console.error('Erro ao importar funis:', error);
                showNotification('‚ùå Erro', 'Falha ao importar: ' + error.message, 'error');
            }

            fileInput.value = '';
        }

        // EDITOR DE FUNIS (c√≥digo original mantido)
        function loadFunnelEditor() {
            const funnelId = document.getElementById('funnelSelect').value;
            currentFunnelData = funnelsData[funnelId];
            document.getElementById('currentFunnelName').textContent = currentFunnelData.name;
            renderSteps();
        }

        function addBlock(type) {
            if (!currentFunnelData) return;
            
            const newStep = {
                id: 'step_' + (currentFunnelData.steps.length + 1),
                type: type,
                text: '',
                mediaUrl: '',
                waitForReply: false,
                timeoutMinutes: undefined,
                nextOnReply: undefined,
                nextOnTimeout: undefined
            };
            
            currentFunnelData.steps.push(newStep);
            renderSteps();
        }

        function removeStep(index) {
            if (!currentFunnelData) return;
            currentFunnelData.steps.splice(index, 1);
            renderSteps();
        }

        function editStep(index) {
            editingStepIndex = index;
            renderSteps();
        }

        function updateStep(index, field, value) {
            if (!currentFunnelData.steps[index]) return;
            
            if (field === 'waitForReply') {
                currentFunnelData.steps[index][field] = value;
            } else if (field === 'timeoutMinutes' || field === 'nextOnReply' || field === 'nextOnTimeout') {
                currentFunnelData.steps[index][field] = value !== '' ? parseInt(value) : undefined;
            } else {
                currentFunnelData.steps[index][field] = value;
            }
            
            renderSteps();
        }

        function getStepIcon(type) {
            const icons = {
                'text': 'T',
                'image': 'üì∑',
                'video': 'üé•',
                'image+text': 'üìù',
                'video+text': 'üé¨',
                'delay': '‚è∞',
                'typing': 'üí¨',
                'audio': 'üéµ'
            };
            return icons[type] || 'T';
        }

        function getStepTypeName(type) {
            const names = {
                'text': 'Mensagem de Texto',
                'image': 'Imagem',
                'video': 'V√≠deo',
                'image+text': 'Imagem + Texto',
                'video+text': 'V√≠deo + Texto',
                'delay': 'Delay',
                'typing': 'Digitando',
                'audio': '√Åudio'
            };
            return names[type] || 'Mensagem';
        }

        function renderSteps() {
            const container = document.getElementById('stepsContainer');
            
            if (!currentFunnelData || currentFunnelData.steps.length === 0) {
                container.innerHTML = `
                    <div class="empty-workspace">
                        <h3>Funil vazio</h3>
                        <p>Adicione blocos da barra lateral para come√ßar a construir seu funil</p>
                    </div>
                `;
                return;
            }

            let html = '';
            currentFunnelData.steps.forEach((step, index) => {
                const isEditing = editingStepIndex === index;
                const stepIcon = getStepIcon(step.type);
                const stepTypeName = getStepTypeName(step.type);
                
                html += `
                    <div class="step-card ${isEditing ? 'editing' : ''}">
                        <div class="step-header">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div class="step-number">${index + 1}</div>
                                <div class="step-type">
                                    <span>${stepIcon}</span>
                                    <span>${stepTypeName}</span>
                                </div>
                            </div>
                            <div class="step-actions">
                                <button class="btn btn-small" onclick="editStep(${index})">
                                    ${isEditing ? 'Salvar' : 'Editar'}
                                </button>
                                <button class="btn btn-small btn-danger" onclick="removeStep(${index})">Remover</button>
                            </div>
                        </div>
                        
                        <div class="step-content">
                            <div class="step-preview" style="display: ${isEditing ? 'none' : 'block'}">
                                ${step.type === 'delay' ? `
                                    <span style="color: #667eea;">‚è∞ Aguardar ${step.delaySeconds || 0} segundos</span>
                                ` : step.type === 'typing' ? `
                                    <span style="color: #667eea;">üí¨ Mostrar "digitando" por ${step.typingSeconds || 3} segundos</span>
                                ` : step.type === 'audio' ? `
                                    <strong style="color: #f59e0b;">üéµ √Åudio:</strong> ${step.mediaUrl || 'URL n√£o configurada'}
                                    ${step.text ? `<br><strong>Texto adicional:</strong> ${step.text.substring(0, 100)}${step.text.length > 100 ? '...' : ''}` : ''}
                                    ${step.waitForReply ? '<br><span style="color: #dc2626;">‚è∏Ô∏è Aguardar resposta do cliente</span>' : ''}
                                ` : `
                                    ${step.delayBefore ? `<span style="color: #f59e0b;">‚è∞ Delay: ${step.delayBefore}s</span><br>` : ''}
                                    ${step.showTyping ? '<span style="color: #667eea;">üí¨ Mostrar "digitando"</span><br>' : ''}
                                    ${step.text ? `<strong>Texto:</strong> ${step.text.substring(0, 100)}${step.text.length > 100 ? '...' : ''}` : ''}
                                    ${step.mediaUrl ? `<br><strong>M√≠dia:</strong> ${step.mediaUrl}` : ''}
                                    ${step.waitForReply ? '<br><span style="color: #dc2626;">‚è∏Ô∏è Aguardar resposta do cliente</span>' : ''}
                                `}
                            </div>
                            
                            <div class="step-config ${isEditing ? 'active' : ''}">
                                ${step.type === 'delay' ? `
                                <div class="form-group">
                                    <label class="form-label">Tempo de Delay</label>
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; align-items: end;">
                                        <input type="number" class="form-input" 
                                            placeholder="30"
                                            value="${step.delaySeconds || ''}"
                                            oninput="updateStep(${index}, 'delaySeconds', this.value)">
                                        <span style="color: #6b7280; font-size: 14px;">segundos</span>
                                    </div>
                                    <small style="color: #6b7280;">Aguardar antes de continuar o funil</small>
                                </div>
                                ` : step.type === 'typing' ? `
                                <div class="form-group">
                                    <label class="form-label">Tempo Digitando</label>
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; align-items: end;">
                                        <input type="number" class="form-input" 
                                            placeholder="3"
                                            value="${step.typingSeconds || ''}"
                                            oninput="updateStep(${index}, 'typingSeconds', this.value)">
                                        <span style="color: #6b7280; font-size: 14px;">segundos</span>
                                    </div>
                                    <small style="color: #6b7280;">Mostrar "est√° digitando..." para o cliente</small>
                                </div>
                                ` : `
                                ${step.type !== 'image' && step.type !== 'video' && step.type !== 'audio' ? `
                                <div class="form-group">
                                    <label class="form-label">Texto da Mensagem</label>
                                    <textarea class="form-input form-textarea" 
                                        placeholder="Digite o texto da mensagem..."
                                        oninput="updateStep(${index}, 'text', this.value)">${step.text || ''}</textarea>
                                </div>
                                ` : ''}
                                
                                ${step.type === 'audio' ? `
                                <div class="form-group" style="background: #fef3c7; padding: 12px; border-radius: 8px; border: 1px solid #f59e0b;">
                                    <label class="form-label" style="color: #92400e;">üéµ URL do √Åudio (obrigat√≥rio)</label>
                                    <input type="url" class="form-input" 
                                        placeholder="https://exemplo.com/audio.mp3"
                                        value="${step.mediaUrl || ''}"
                                        oninput="updateStep(${index}, 'mediaUrl', this.value)"
                                        style="border-color: #f59e0b;">
                                    <small style="color: #92400e;">
                                        Formatos aceitos: MP3, M4A, OGG. Tamanho m√°ximo recomendado: 16MB
                                    </small>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Texto adicional (opcional)</label>
                                    <textarea class="form-input form-textarea" 
                                        placeholder="Texto que acompanha o √°udio (opcional)..."
                                        oninput="updateStep(${index}, 'text', this.value)">${step.text || ''}</textarea>
                                </div>
                                ` : ''}

                                ${(step.type === 'image' || step.type === 'video' || step.type === 'image+text' || step.type === 'video+text') && step.type !== 'audio' ? `
                                <div class="form-group">
                                    <label class="form-label">URL da M√≠dia</label>
                                    <input type="url" class="form-input" 
                                        placeholder="https://exemplo.com/arquivo.${step.type.includes('video') ? 'mp4' : 'jpg'}"
                                        value="${step.mediaUrl || ''}"
                                        oninput="updateStep(${index}, 'mediaUrl', this.value)">
                                </div>
                                ` : ''}

                                ${(step.type === 'image+text' || step.type === 'video+text') ? `
                                <div class="form-group">
                                    <label class="form-label">Texto/Legenda</label>
                                    <textarea class="form-input form-textarea" 
                                        placeholder="Digite o texto que acompanha a m√≠dia..."
                                        oninput="updateStep(${index}, 'text', this.value)">${step.text || ''}</textarea>
                                </div>
                                ` : ''}
                                
                                <div class="form-group">
                                    <label class="form-label">Delay antes desta mensagem</label>
                                    <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 8px; align-items: end;">
                                        <input type="number" class="form-input" 
                                            placeholder="0"
                                            value="${step.delayBefore || ''}"
                                            oninput="updateStep(${index}, 'delayBefore', this.value)">
                                        <span style="color: #6b7280; font-size: 14px;">segundos</span>
                                    </div>
                                </div>
                                
                                <div class="form-checkbox">
                                    <input type="checkbox" id="typing_${index}" 
                                        ${step.showTyping ? 'checked' : ''}
                                        onchange="updateStep(${index}, 'showTyping', this.checked)">
                                    <label for="typing_${index}">Mostrar "digitando" antes de enviar</label>
                                </div>

                                ${(step.type === 'text' || step.type === 'image' || step.type === 'video' || step.type === 'audio' || step.type === 'image+text' || step.type === 'video+text') ? `
                                <div class="form-checkbox">
                                    <input type="checkbox" id="wait_${index}" 
                                        ${step.waitForReply ? 'checked' : ''}
                                        onchange="updateStep(${index}, 'waitForReply', this.checked)">
                                    <label for="wait_${index}">‚è∏Ô∏è Aguardar resposta do cliente para continuar</label>
                                </div>

                                ${step.waitForReply ? `
                                <div style="margin-left: 24px; margin-top: 12px; padding: 12px; background: #fef3c7; border-radius: 6px;">
                                    <div class="form-group">
                                        <label class="form-label">Timeout em minutos (vazio = aguardar indefinidamente)</label>
                                        <input type="number" class="form-input" 
                                            placeholder="60"
                                            value="${step.timeoutMinutes || ''}"
                                            oninput="updateStep(${index}, 'timeoutMinutes', this.value)">
                                    </div>
                                </div>
                                ` : ''}
                                ` : ''}
                                `}
                            </div>
                        </div>
                    </div>
                `;
                
                if (index < currentFunnelData.steps.length - 1) {
                    html += `
                        <div class="connector">
                            <div class="connector-line">
                                <div class="connector-arrow"></div>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        async function saveFunnel() {
            if (!currentFunnelData) {
                alert('Selecione um funil para salvar');
                return;
            }
            
            if (currentFunnelData.steps.length === 0) {
                alert('Adicione pelo menos um passo ao funil');
                return;
            }
            
            for (let i = 0; i < currentFunnelData.steps.length; i++) {
                const step = currentFunnelData.steps[i];
                
                if (step.type === 'text') {
                    if (!step.text || step.text.trim() === '') {
                        alert(`Passo ${i + 1}: Texto √© obrigat√≥rio para mensagens de texto`);
                        return;
                    }
                } else if (step.type === 'delay') {
                    if (!step.delaySeconds || step.delaySeconds <= 0) {
                        alert(`Passo ${i + 1}: Tempo de delay √© obrigat√≥rio`);
                        return;
                    }
                } else if (step.type === 'typing') {
                    if (!step.typingSeconds || step.typingSeconds <= 0) {
                        alert(`Passo ${i + 1}: Tempo de digita√ß√£o √© obrigat√≥rio`);
                        return;
                    }
                } else if (step.type === 'image' || step.type === 'video' || step.type === 'audio' || step.type === 'image+text' || step.type === 'video+text') {
                    if (!step.mediaUrl || step.mediaUrl.trim() === '') {
                        const mediaType = step.type === 'audio' ? '√°udio' : 
                                         step.type.includes('video') ? 'v√≠deo' : 'imagem';
                        alert(`Passo ${i + 1}: URL do ${mediaType} √© obrigat√≥ria`);
                        return;
                    }
                }
            }
